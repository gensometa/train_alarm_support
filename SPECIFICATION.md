# 電車乗り過ごし防止アプリ 仕様書

## 1. プロジェクト概要

### 1.1 アプリ名
**乗換アラーム**

### 1.2 コンセプト
電車での移動中、目的駅の手前で確実に通知を受け取り、乗り過ごしを防止するモバイルアプリ。

### 1.3 ターゲットユーザー
- **通勤・通学者**: 毎日同じルートを利用し、居眠りや集中して乗り過ごすリスクがある人
- **旅行者・外出者**: 初めての路線でも安心して利用できるシンプルな操作を求める人

### 1.4 対応プラットフォーム
- iOS 14.0以上
- Android 8.0 (API 26) 以上

### 1.5 開発技術
- **フレームワーク**: Flutter 3.x
- **言語**: Dart
- **状態管理**: Riverpod
- **ローカルDB**: SQLite (sqflite)
- **駅検索API**: HeartRails Express API

---

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 乗換案内インポート機能

| 機能 | 説明 |
|------|------|
| テキスト貼り付け | Yahoo!乗換案内からコピーしたテキストを貼り付け |
| 自動パース | ルート情報を自動解析し、乗換駅・時刻を抽出 |
| 駅位置自動取得 | HeartRails Express APIで駅の緯度・経度を自動取得 |
| 複数ポイント監視 | 各乗換駅で個別に通知を設定 |
| 交通手段対応 | 電車・バス・徒歩を認識 |
| **ポイント別設定** | 各乗換駅でGPS/タイマーを個別選択可能 |
| **地下鉄自動検出** | 地下鉄路線を自動検出し、タイマーモードを推奨 |
| **到着時刻自動設定** | パースした到着時刻からタイマーを自動設定 |

**対応フォーマット**
- ✅ Yahoo!乗換案内（サポート対象）
- ❌ ジョルダン乗換案内（未対応）
- ❌ Google Maps（未対応）
- ❌ NAVITIME（未対応）

**Yahoo!乗換案内からのコピー方法**

| プラットフォーム | 操作手順 |
|------------------|----------|
| **iOS** | 検索結果画面 → 共有ボタン → 「コピー」 |
| **Android** | 検索結果画面 → 「LINE・メールで送る」→「クリップボードにコピー」 |

**パース例（Yahoo!乗換案内）**
```
入力テキスト:
■溝の口
↓ 17:08〜17:13
↓ 東急田園都市線 中央林間行
■宮前平
↓ 17:14〜17:15
↓ 徒歩
■宮前平駅/川崎市バス
↓ 17:17〜17:19
↓ 川崎市バス・溝１５ 宮前区役所前行
▼[乗換不要] 宮前区役所前/川崎市バス
↓ 17:19〜17:30
■南平/川崎市バス

抽出結果:
┌───────────────────────────────────────┐
│ 乗換ポイント1: 宮前平             │
│   到着予定: 17:13                     │
│   交通手段: 東急田園都市線            │
│   通知: GPS (500m手前) or タイマー    │
├───────────────────────────────────────┤
│ 乗換ポイント2: 宮前区役所前       │
│   到着予定: 17:19                     │
│   交通手段: 川崎市バス                │
│   通知: タイマー (17:17)              │
├───────────────────────────────────────┤
│ 最終目的地: 南平                      │
│   到着予定: 17:30                     │
│   交通手段: 川崎市バス                │
│   通知: タイマー (17:28)              │
└───────────────────────────────────────┘
```

#### 2.1.2 目的地管理機能（ジオフェンス）

| 機能 | 説明 |
|------|------|
| 目的地登録 | 複数の目的地（自宅、職場、よく行く駅等）を登録 |
| ON/OFF切り替え | 各目的地の監視を個別にトグルボタンでON/OFF |
| 半径設定 | 500m / 1km / 2km / 3km / 5km / 7km / 10km から選択 |
| マップ表示 | 選択した半径を地図上に円で表示 |
| 常時監視 | バックグラウンドで常に監視し、範囲内に入ったら通知 |
| 用途例 | 通勤ルートの乗換駅を登録→操作不要で自動通知 |

**使用例**
- 「自宅」を登録（半径2km）→ 帰宅時に自動で通知
- 「会社最寄り駅」を登録（半径1km）→ 出勤時に自動で通知
- 複数の目的地を登録し、トグルでその日必要なものだけON

#### 2.1.3 地下鉄対応（自動検出）

| 機能 | 説明 |
|------|------|
| 自動検出 | 路線名から地下鉄を自動判定（メトロ、地下鉄、都営等） |
| タイマー推奨 | 地下鉄区間はGPSが不安定なためタイマーを自動推奨 |
| 到着前通知 | 到着1分前/2分前/3分前から選択可能（デフォルト: 2分前） |

### 2.2 通知・アラーム機能

#### 2.2.1 通知オプション
- **プッシュ通知**: 必須（サイレントモードでも通知表示）
- **アラーム音**: 選択可能
- **バイブレーション**: パターン選択可能
- **繰り返し通知**: 確認するまで一定間隔で再通知

#### 2.2.2 通知回数制限
| 設定項目 | 説明 |
|----------|------|
| 最大通知回数 | デフォルト50回、設定で変更可能（10〜100回） |
| リセット | 監視停止時または日次でリセット |

### 2.3 駅データ

#### 2.3.1 駅検索API
| 項目 | 説明 |
|------|------|
| API | [HeartRails Express API](https://express.heartrails.com/api.html) |
| 機能 | 駅名から緯度・経度を取得 |
| 料金 | 無料（クレジット表示必要） |
| 特徴 | 常に最新の駅データを利用可能 |

#### 2.3.2 API使用方法
```
# 駅名で検索
GET https://express.heartrails.com/api/json?method=getStations&name=渋谷

# レスポンス例
{
  "response": {
    "station": [
      {
        "name": "渋谷",
        "prefecture": "東京都",
        "line": "JR山手線",
        "x": 139.701238,  // 経度
        "y": 35.658871    // 緯度
      },
      ...
    ]
  }
}
```

### 2.4 設定機能

| 項目 | 説明 |
|------|------|
| 通知距離 | ジオフェンスの半径（500m〜10km） |
| 地下鉄通知タイミング | 到着1分前/2分前/3分前（デフォルト: 2分前） |
| 最大通知回数 | 10〜100回（デフォルト: 50回） |
| アラーム音量 | システム音量とは別に設定可能 |
| バイブレーションパターン | 弱・中・強 |
| チュートリアル再表示 | チュートリアルを再度確認 |

### 2.5 広告・課金機能

#### 2.5.1 広告表示
| 機能 | 説明 |
|------|------|
| 表示位置 | フッター（画面下部バナー）のみ |
| 非侵入的 | 全画面広告・動画広告なし |
| 監視中非表示 | 監視画面では広告を非表示（集中妨害防止） |
| 広告プロバイダ | Google AdMob |

#### 2.5.2 アプリ内課金
| 機能 | 説明 |
|------|------|
| 広告削除 | 一度の課金で永久に広告を削除 |
| 復元機能 | 機種変更時に購入状態を復元可能 |
| 価格帯 | 240円〜480円程度（要検討） |

### 2.6 チュートリアル機能

| 機能 | 説明 |
|------|------|
| 初回表示 | アプリ初回起動時のみ自動表示 |
| スキップ可能 | いつでもスキップ可能 |
| 再表示 | 設定画面から再度確認可能 |
| 内容 | 基本操作、Yahoo!乗換案内からのコピー方法、目的地登録 |

---

## 3. 画面構成

### 3.1 画面一覧

```
📱 アプリ構成
├── チュートリアル画面（初回のみ）
├── スプラッシュ画面
├── ホーム画面（メイン）
│   ├── インポートタブ（乗換案内）
│   └── 目的地タブ（ジオフェンス管理）
├── 目的地登録/編集画面
│   ├── 場所検索（HeartRails API）
│   ├── 地図選択
│   ├── 半径選択（500m〜10km）
│   └── マップ上に半径表示
├── 監視中画面
└── 設定画面
    ├── 通知設定
    ├── 最大通知回数
    ├── 広告削除（課金）
    ├── チュートリアル再表示
    └── クレジット表示（HeartRails Express）
```

### 3.2 画面詳細

#### インポートタブ
```
┌─────────────────────────────────────┐
│  [📍 インポート]  [🏠 目的地]       │
├─────────────────────────────────────┤
│                                     │
│  ℹ️ Yahoo!乗換案内から          │
│     ルート情報を貼り付けてください  │
│                                     │
│  ━━━ コピー方法 ━━━                 │
│  iOS: 共有 → コピー                 │
│  Android: LINE・メールで送る        │
│           → クリップボードにコピー  │
│                                     │
│  ┌─────────────────────────────┐   │
│  │ ここにテキストを            │   │
│  │ 貼り付けてください...       │   │
│  └─────────────────────────────┘   │
│  [📋 貼り付け]  [✕ クリア]         │
│                                     │
├─────────────────────────────────────┤
│  検出されたポイント (3/4 通知ON)    │
│  ┌─────────────────────────────┐   │
│  │ 🚃 溝の口 [出発]            │   │
│  │ 🚃 宮前平 17:13       [ON]  │   │
│  │    GPS ○  タイマー ●        │   │
│  │ 🚇 永田町 17:45       [ON]  │   │
│  │    🔔 地下鉄検出             │   │
│  │    GPS ○  タイマー ●        │   │
│  │    到着 [2分▼] 前に通知     │   │
│  │ 🚃 南平 17:55 [到着]  [ON]  │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │       ▶ 監視を開始          │   │
│  └─────────────────────────────┘   │
│  ─────────── 広告 ───────────      │
└─────────────────────────────────────┘
```

#### 目的地タブ
```
┌─────────────────────────────────────┐
│  [📍 インポート]  [🏠 目的地]       │
├─────────────────────────────────────┤
│                                     │
│  登録済み目的地                     │
│  ┌─────────────────────────────┐   │
│  │ 🏠 自宅                      │   │
│  │    半径: 2km                 │   │
│  │    [━━━━━━━━━━○] ON         │   │
│  ├─────────────────────────────┤   │
│  │ 🏢 会社最寄り駅              │   │
│  │    半径: 1km                 │   │
│  │    [○━━━━━━━━━━] OFF        │   │
│  ├─────────────────────────────┤   │
│  │ 🚉 乗換駅                │   │
│  │    半径: 500m                │   │
│  │    [━━━━━━━━━━○] ON         │   │
│  └─────────────────────────────┘   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │     ＋ 目的地を追加          │   │
│  └─────────────────────────────┘   │
│                                     │
│  ─────────── 広告 ───────────      │
└─────────────────────────────────────┘
```

---

## 4. システム構成

### 4.1 主要パッケージ

| カテゴリ | パッケージ | 用途 |
|----------|------------|------|
| 状態管理 | flutter_riverpod | 状態管理 |
| 位置情報 | geolocator | GPS取得 |
| 通知 | flutter_local_notifications | ローカル通知 |
| DB | sqflite | ローカルデータ保存 |
| ルーティング | go_router | 画面遷移 |
| 地図表示 | flutter_map + latlong2 | OpenStreetMap表示 |
| HTTP通信 | http / dio | API通信 |
| 広告 | google_mobile_ads | AdMobバナー広告 |
| 課金 | in_app_purchase | アプリ内課金 |
| チュートリアル | introduction_screen | 初回チュートリアル |
| 設定保存 | shared_preferences | 設定保存 |

### 4.2 外部API

| API | 用途 | 料金 | 制限 |
|-----|------|------|------|
| [HeartRails Express](https://express.heartrails.com/) | 駅名→座標変換 | 無料 | クレジット表示必要 |
| OpenStreetMap | 地図表示 | 無料 | ODbLライセンス |

---

## 5. 開発フェーズ

### Phase 1: MVP（基本機能）✅ 完了
- [x] プロジェクトセットアップ
- [x] 駅データベース（ローカル・サンプル）
- [x] GPS監視機能
- [x] タイマー機能
- [x] 基本的な通知機能
- [x] Yahoo!乗換案内インポート

### Phase 2: 機能統合・API連携
- [ ] GPSタブ・タイマータブの廃止
- [ ] インポート + 目的地の2タブ構成
- [ ] HeartRails Express API統合
- [ ] インポート時の駅座標自動取得
- [ ] 通知回数制限機能

### Phase 3: 収益化・UX
- [x] チュートリアル機能
- [x] 広告機能（AdMob）
- [x] アプリ内課金
- [ ] HeartRails Expressクレジット表示

### Phase 4: 品質向上・リリース
- [ ] 通知機能の修正・テスト
- [ ] パフォーマンス最適化
- [ ] App Store / Google Play 申請準備

---

## 6. クレジット・ライセンス

### 必須クレジット表示
```
駅データ: HeartRails Express
https://express.heartrails.com/

地図: OpenStreetMap contributors
```

---

**ドキュメント情報**
- 作成日: 2026-01-14
- 更新日: 2026-01-16
- バージョン: 3.0
- 変更履歴:
  - v3.0: 大幅な構成変更
    - GPSタブ・タイマータブを廃止、2タブ構成に
    - よく使うルート機能を廃止
    - 目的地管理を中心機能に
    - HeartRails Express API採用（駅検索）
    - Yahoo!乗換案内のみサポート（コピー方法明記）
    - 通知回数制限機能追加
  - v2.0: 機能追加（地下鉄検出、広告、課金、チュートリアル等）
  - v1.0: 初版作成
